
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Camera and iPhone - Marcin Pędzimąż</title>
	<meta name="author" content="Marcin Pędzimąż">

	
	<meta name="description" content="It&rsquo;s been a while since i wrote last post but it is time to cover another topic. I start seeing more and more Instagram like apps and as i have &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Marcin Pędzimąż" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Marcin Pędzimąż</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="https://www.google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:noxytrux.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/noxytrux" title="Twitter">Twitter</a>
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="https://www.google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:noxytrux.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">Camera and iPhone</h2>
	<div class="entry-content"><p>It&rsquo;s been a while since i wrote last post but it is time to cover another topic. I start seeing more and more Instagram like apps and as i have to put some camera preview in one of the last apps i was developing. I come to idea that is it a good thing to talk about. Basically if you want to use camera in you app you are using <code>UIImagePickerController</code> and in most cases is good enought. But what if you really need some nice custom animations and most of all custom size?</p>

<!--more-->


<p>Yeah you can say that if it comes to this we can use <code>AVCaptureVideoPreviewLayer</code> and this will cover all edge cases with animation and additional decorations , size etc. Ok you are right in this case your code will looks like this and we are done.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setupCamera</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">//setup session</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">AVCaptureSession</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">sessionPreset</span> <span class="o">=</span> <span class="n">AVCaptureSessionPresetPhoto</span><span class="p">;</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">videoDevice</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="n">frontCamera</span><span class="p">];</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">videoInput</span> <span class="o">=</span> <span class="p">[</span><span class="bp">AVCaptureDeviceInput</span> <span class="nl">deviceInputWithDevice</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">videoDevice</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">session</span> <span class="nl">addInput</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">videoInput</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">captureVideoPreviewLayer</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">AVCaptureVideoPreviewLayer</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithSession</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">session</span><span class="p">];</span>
</span><span class='line'>    <span class="bp">CALayer</span> <span class="o">*</span><span class="n">viewLayer</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">cameraButton</span><span class="p">.</span><span class="n">layer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="n">viewLayer</span> <span class="nl">setMasksToBounds</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">captureVideoPreviewLayer</span><span class="p">.</span><span class="n">videoGravity</span> <span class="o">=</span> <span class="n">AVLayerVideoGravityResizeAspectFill</span><span class="p">;</span>
</span><span class='line'>    <span class="p">[[</span><span class="nb">self</span><span class="p">.</span><span class="n">captureVideoPreviewLayer</span> <span class="n">connection</span><span class="p">]</span> <span class="nl">setVideoOrientation</span><span class="p">:</span> <span class="n">AVCaptureVideoOrientationLandscapeRight</span><span class="p">];</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">captureVideoPreviewLayer</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="p">[</span><span class="n">viewLayer</span> <span class="n">bounds</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">viewLayer</span> <span class="nl">addSublayer</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">captureVideoPreviewLayer</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Start Running the Session</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">session</span> <span class="n">startRunning</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//fade in </span>
</span><span class='line'>    <span class="bp">CABasicAnimation</span> <span class="o">*</span><span class="n">anim</span> <span class="o">=</span> <span class="p">[</span><span class="bp">CABasicAnimation</span> <span class="nl">animationWithKeyPath</span><span class="p">:</span><span class="s">@&quot;opacity&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="n">anim</span><span class="p">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="l">@(</span><span class="mi">0</span><span class="l">)</span><span class="p">;</span>
</span><span class='line'>    <span class="n">anim</span><span class="p">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="l">@(</span><span class="mi">1</span><span class="l">)</span><span class="p">;</span>
</span><span class='line'>    <span class="n">anim</span><span class="p">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mf">0.5f</span><span class="p">;</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">captureVideoPreviewLayer</span> <span class="nl">addAnimation</span><span class="p">:</span><span class="n">anim</span> <span class="nl">forKey</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>But we don&rsquo;t want it to be easy right? well let&rsquo;s say we need some effect like in instagram to make it simple let&rsquo;s use saturation:</p>

<p><img class="center" src="/assets/images/CustomCamera.gif" width="400"></p>

<p>I&rsquo;m using here OpenGL <code>GLKitViewController</code> attached to my rootViewController with some custom shader.</p>

<p>Advantages:</p>

<p>-Fully customizable<br/>
-Whatever size i want<br/>
-Can apply CAAnimation, UIView aniamtion etc<br/>
-It&rsquo;s bloody fast</p>

<p>Of course i&rsquo;m not telling this is the best option possible i saw some benchmarks revealing that Accelerate framework from Apple can win i some cases. This is a good moment to talk about something i saw that many developers that are not involved in gamedev thought that learning OpenGL is wast of time, which is not true as knowing how GPU works and how to program it gives you almost endless possibilities and in many cases the best performance possible. Trust me i&rsquo;m an engineer :)</p>

<p>Ok enought talking show me some code: (I&rsquo;m assuming that you know the basics of OpenGL ES, if not there are some good <a href="http://www.raywenderlich.com/3664/opengl-tutorial-for-ios-opengl-es-2-0">tutorials</a> that explaing it)</p>

<p>Let&rsquo;s start with setting up our scene, we need main controller with some GLKitViewController attached to it by embed segue using container.</p>

<p><img class="center" src="/assets/images/scene.png" width="700"></p>

<p>Now we need to handle the segue in our main controller</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">prepareForSegue:</span><span class="p">(</span><span class="bp">UIStoryboardSegue</span> <span class="o">*</span><span class="p">)</span><span class="nv">segue</span> <span class="nf">sender:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">sender</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">([</span><span class="n">segue</span><span class="p">.</span><span class="n">identifier</span> <span class="nl">isEqualToString</span><span class="p">:</span><span class="n">MDPSegueIdentifiers</span><span class="p">.</span><span class="n">customCamera</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">MPDCustomCameraViewController</span> <span class="o">*</span><span class="n">cameraController</span> <span class="o">=</span> <span class="n">segue</span><span class="p">.</span><span class="n">destinationViewController</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">self</span><span class="p">.</span><span class="n">cameraController</span> <span class="o">=</span> <span class="n">cameraController</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">[</span><span class="nb">self</span> <span class="nl">decorateCameraController</span><span class="p">:</span><span class="n">cameraController</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="nb">self</span> <span class="nl">animateCameraController</span><span class="p">:</span><span class="n">cameraController</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">[</span><span class="n">cameraController</span> <span class="n">startCameraCapture</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Both function are not important right now. One of it simply animate the camera view and second one mask it to the shape of the circle. Now let&rsquo;s talk about our heart of app.</p>

<p>To render Camera output in OpenGL we need to capture it texture somehow. Gladly Apple AVCaptureSession allow us to bind camera output directly to textures using <a href="http://en.wikipedia.org/wiki/YCbCr">YCbCr</a> color space.</p>

<p>First we need to setup OpenGL view:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="nb">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">EAGLContext</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithAPI</span><span class="p">:</span><span class="n">kEAGLRenderingAPIOpenGLES2</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">self</span><span class="p">.</span><span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Failed to create ES context&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//create Opengl view we are processing view update on demand so pause the view</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">glView</span> <span class="o">=</span> <span class="p">(</span><span class="bp">GLKView</span> <span class="o">*</span><span class="p">)</span><span class="nb">self</span><span class="p">.</span><span class="n">view</span><span class="p">;</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">glView</span><span class="p">.</span><span class="n">context</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">context</span><span class="p">;</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">glView</span><span class="p">.</span><span class="n">drawableDepthFormat</span> <span class="o">=</span> <span class="n">GLKViewDrawableDepthFormat24</span><span class="p">;</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">preferredFramesPerSecond</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">glView</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="bp">UIColor</span> <span class="n">whiteColor</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">retinaScaleFactor</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">UIScreen</span> <span class="n">mainScreen</span><span class="p">]</span> <span class="n">nativeScale</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">contentScaleFactor</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">retinaScaleFactor</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">_sessionPreset</span> <span class="o">=</span> <span class="n">AVCaptureSessionPreset640x480</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span> <span class="n">setupGL</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span> <span class="n">setupAVCapture</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now lets setup AVSession to preapre data capture into 2 textures one containing chroma and second one luma as described in YCbCr spec.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="n">CVReturn</span> <span class="n">err</span> <span class="o">=</span> <span class="n">CVOpenGLESTextureCacheCreate</span><span class="p">(</span><span class="n">kCFAllocatorDefault</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_context</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_videoTextureCache</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error at CVOpenGLESTextureCacheCreate %d&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//-- Setup Capture Session.</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">AVCaptureSession</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">session</span> <span class="n">beginConfiguration</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//-- Set preset session size.</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">session</span> <span class="nl">setSessionPreset</span><span class="p">:</span><span class="n">_sessionPreset</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//-- Creata a video device and input from that Device.  Add the input to the capture session.</span>
</span><span class='line'>    <span class="bp">NSArray</span> <span class="o">*</span><span class="n">devices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">AVCaptureDevice</span> <span class="nl">devicesWithMediaType</span><span class="p">:</span><span class="n">AVMediaTypeVideo</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">AVCaptureDevice</span> <span class="o">*</span> <span class="n">videoDevice</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="bp">AVCaptureDevice</span> <span class="o">*</span><span class="n">device</span> <span class="k">in</span> <span class="n">devices</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">([</span><span class="n">device</span> <span class="nl">hasMediaType</span><span class="p">:</span><span class="n">AVMediaTypeVideo</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="p">([</span><span class="n">device</span> <span class="n">position</span><span class="p">]</span> <span class="o">==</span> <span class="n">AVCaptureDevicePositionFront</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">videoDevice</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">videoDevice</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span>
</span><span class='line'>        <span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//-- Add the device to the session.</span>
</span><span class='line'>    <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
</span><span class='line'>    <span class="bp">AVCaptureDeviceInput</span> <span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="p">[</span><span class="bp">AVCaptureDeviceInput</span> <span class="nl">deviceInputWithDevice</span><span class="p">:</span><span class="n">videoDevice</span> <span class="nl">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
</span><span class='line'>        <span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">session</span> <span class="nl">addInput</span><span class="p">:</span><span class="n">input</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//-- Create the output for the capture session.</span>
</span><span class='line'>    <span class="bp">AVCaptureVideoDataOutput</span> <span class="o">*</span> <span class="n">dataOutput</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">AVCaptureVideoDataOutput</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">dataOutput</span> <span class="nl">setAlwaysDiscardsLateVideoFrames</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span> <span class="c1">// Probably want to set this to NO when recording</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//-- Set to YUV420.</span>
</span><span class='line'>    <span class="p">[</span><span class="n">dataOutput</span> <span class="nl">setVideoSettings</span><span class="p">:[</span><span class="bp">NSDictionary</span> <span class="nl">dictionaryWithObject</span><span class="p">:[</span><span class="bp">NSNumber</span> <span class="nl">numberWithInt</span><span class="p">:</span><span class="n">kCVPixelFormatType_420YpCbCr8BiPlanarFullRange</span><span class="p">]</span>
</span><span class='line'>                                                             <span class="nl">forKey</span><span class="p">:(</span><span class="kt">id</span><span class="p">)</span><span class="n">kCVPixelBufferPixelFormatTypeKey</span><span class="p">]];</span> <span class="c1">// Necessary for manual preview</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Set dispatch to be on the main thread so OpenGL can do things with the data</span>
</span><span class='line'>    <span class="p">[</span><span class="n">dataOutput</span> <span class="nl">setSampleBufferDelegate</span><span class="p">:</span><span class="nb">self</span> <span class="nl">queue</span><span class="p">:</span><span class="n">dispatch_get_main_queue</span><span class="p">()];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">session</span> <span class="nl">addOutput</span><span class="p">:</span><span class="n">dataOutput</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">session</span> <span class="n">commitConfiguration</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code simply setup camera output to render in YCbCr mode which will return in delegate data for 2 textues. Also we setup device to front camera if you want to use Back camera modify this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="bp">AVCaptureDevice</span> <span class="o">*</span> <span class="n">videoDevice</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="bp">AVCaptureDevice</span> <span class="o">*</span><span class="n">device</span> <span class="k">in</span> <span class="n">devices</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">([</span><span class="n">device</span> <span class="nl">hasMediaType</span><span class="p">:</span><span class="n">AVMediaTypeVideo</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="p">([</span><span class="n">device</span> <span class="n">position</span><span class="p">]</span> <span class="o">==</span> <span class="n">AVCaptureDevicePositionFront</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">videoDevice</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And replace <code>AVCaptureDevicePositionFront</code> with <code>AVCaptureDevicePositionBack</code>.</p>

<p>Now most important function this one will capture our output and generate new textues for shader every frame.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">captureOutput:</span><span class="p">(</span><span class="bp">AVCaptureOutput</span> <span class="o">*</span><span class="p">)</span><span class="nv">captureOutput</span>
</span><span class='line'><span class="nf">didOutputSampleBuffer:</span><span class="p">(</span><span class="n">CMSampleBufferRef</span><span class="p">)</span><span class="nv">sampleBuffer</span>
</span><span class='line'>       <span class="nf">fromConnection:</span><span class="p">(</span><span class="bp">AVCaptureConnection</span> <span class="o">*</span><span class="p">)</span><span class="nv">connection</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CVReturn</span> <span class="n">err</span><span class="p">;</span>
</span><span class='line'>    <span class="n">CVImageBufferRef</span> <span class="n">pixelBuffer</span> <span class="o">=</span> <span class="n">CMSampleBufferGetImageBuffer</span><span class="p">(</span><span class="n">sampleBuffer</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">width</span> <span class="o">=</span> <span class="n">CVPixelBufferGetWidth</span><span class="p">(</span><span class="n">pixelBuffer</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">height</span> <span class="o">=</span> <span class="n">CVPixelBufferGetHeight</span><span class="p">(</span><span class="n">pixelBuffer</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_videoTextureCache</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;No video texture cache&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span> <span class="n">cleanUpTextures</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// CVOpenGLESTextureCacheCreateTextureFromImage will create GLES texture</span>
</span><span class='line'>    <span class="c1">// optimally from CVImageBufferRef.</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Y-plane</span>
</span><span class='line'>    <span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL_TEXTURE0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">err</span> <span class="o">=</span> <span class="n">CVOpenGLESTextureCacheCreateTextureFromImage</span><span class="p">(</span><span class="n">kCFAllocatorDefault</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="n">_videoTextureCache</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="n">pixelBuffer</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="nb">NULL</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="n">GL_TEXTURE_2D</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="n">GL_RED_EXT</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">width</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">height</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="n">GL_RED_EXT</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="n">GL_UNSIGNED_BYTE</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="o">&amp;</span><span class="n">_lumaTexture</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error at CVOpenGLESTextureCacheCreateTextureFromImage %d&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">glBindTexture</span><span class="p">(</span><span class="n">CVOpenGLESTextureGetTarget</span><span class="p">(</span><span class="n">_lumaTexture</span><span class="p">),</span> <span class="n">CVOpenGLESTextureGetName</span><span class="p">(</span><span class="n">_lumaTexture</span><span class="p">));</span>
</span><span class='line'>    <span class="n">glTexParameterf</span><span class="p">(</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="n">GL_TEXTURE_WRAP_S</span><span class="p">,</span> <span class="n">GL_CLAMP_TO_EDGE</span><span class="p">);</span>
</span><span class='line'>    <span class="n">glTexParameterf</span><span class="p">(</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="n">GL_TEXTURE_WRAP_T</span><span class="p">,</span> <span class="n">GL_CLAMP_TO_EDGE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// UV-plane</span>
</span><span class='line'>    <span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL_TEXTURE1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">err</span> <span class="o">=</span> <span class="n">CVOpenGLESTextureCacheCreateTextureFromImage</span><span class="p">(</span><span class="n">kCFAllocatorDefault</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="n">_videoTextureCache</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="n">pixelBuffer</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="nb">NULL</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="n">GL_TEXTURE_2D</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="n">GL_RG_EXT</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">),</span>
</span><span class='line'>                                                       <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">),</span>
</span><span class='line'>                                                       <span class="n">GL_RG_EXT</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="n">GL_UNSIGNED_BYTE</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                                                       <span class="o">&amp;</span><span class="n">_chromaTexture</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error at CVOpenGLESTextureCacheCreateTextureFromImage %d&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">glBindTexture</span><span class="p">(</span><span class="n">CVOpenGLESTextureGetTarget</span><span class="p">(</span><span class="n">_chromaTexture</span><span class="p">),</span> <span class="n">CVOpenGLESTextureGetName</span><span class="p">(</span><span class="n">_chromaTexture</span><span class="p">));</span>
</span><span class='line'>    <span class="n">glTexParameterf</span><span class="p">(</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="n">GL_TEXTURE_WRAP_S</span><span class="p">,</span> <span class="n">GL_CLAMP_TO_EDGE</span><span class="p">);</span>
</span><span class='line'>    <span class="n">glTexParameterf</span><span class="p">(</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="n">GL_TEXTURE_WRAP_T</span><span class="p">,</span> <span class="n">GL_CLAMP_TO_EDGE</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Rendering is quiet simple:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">glkView:</span><span class="p">(</span><span class="bp">GLKView</span> <span class="o">*</span><span class="p">)</span><span class="nv">view</span> <span class="nf">drawInRect:</span><span class="p">(</span><span class="bp">CGRect</span><span class="p">)</span><span class="nv">rect</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">glViewport</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>               <span class="n">rect</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="o">*</span><span class="nb">self</span><span class="p">.</span><span class="n">retinaScaleFactor</span><span class="p">,</span>
</span><span class='line'>               <span class="n">rect</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="o">*</span><span class="nb">self</span><span class="p">.</span><span class="n">retinaScaleFactor</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">glClearColor</span><span class="p">(</span><span class="mf">0.5f</span><span class="p">,</span> <span class="mf">0.5f</span><span class="p">,</span> <span class="mf">0.5f</span><span class="p">,</span> <span class="mf">1.0f</span><span class="p">);</span>
</span><span class='line'>    <span class="n">glClear</span><span class="p">(</span><span class="n">GL_COLOR_BUFFER_BIT</span> <span class="o">|</span> <span class="n">GL_DEPTH_BUFFER_BIT</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">_lumaTexture</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">_chromaTexture</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">glUseProgram</span><span class="p">(</span><span class="n">_shaderProgram</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL_TEXTURE0</span><span class="p">);</span>
</span><span class='line'>        <span class="n">glBindTexture</span><span class="p">(</span><span class="n">CVOpenGLESTextureGetTarget</span><span class="p">(</span><span class="n">_lumaTexture</span><span class="p">),</span> <span class="n">CVOpenGLESTextureGetName</span><span class="p">(</span><span class="n">_lumaTexture</span><span class="p">));</span>
</span><span class='line'>        <span class="n">glUniform1i</span><span class="p">(</span><span class="n">_tex1Uniform</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="n">glActiveTexture</span><span class="p">(</span><span class="n">GL_TEXTURE1</span><span class="p">);</span>
</span><span class='line'>        <span class="n">glBindTexture</span><span class="p">(</span><span class="n">CVOpenGLESTextureGetTarget</span><span class="p">(</span><span class="n">_chromaTexture</span><span class="p">),</span> <span class="n">CVOpenGLESTextureGetName</span><span class="p">(</span><span class="n">_chromaTexture</span><span class="p">));</span>
</span><span class='line'>        <span class="n">glUniform1i</span><span class="p">(</span><span class="n">_tex2Uniform</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="n">glUniformMatrix4fv</span><span class="p">(</span><span class="n">_matrixUniform</span><span class="p">,</span> <span class="mi">1</span> <span class="p">,</span><span class="nb">false</span> <span class="p">,</span><span class="n">GLKMatrix4MakeRotation</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="n">m</span><span class="p">);</span>
</span><span class='line'>        <span class="n">glUniform1f</span><span class="p">(</span><span class="n">_saturationUniform</span><span class="p">,</span> <span class="n">_saturation</span><span class="p">);</span>
</span><span class='line'>        <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_DEPTH_TEST</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">glVertexAttribPointer</span><span class="p">(</span><span class="n">ATTRIB_VERTEX</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GL_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">squareVertices</span><span class="p">);</span>
</span><span class='line'>        <span class="n">glEnableVertexAttribArray</span><span class="p">(</span><span class="n">ATTRIB_VERTEX</span><span class="p">);</span>
</span><span class='line'>        <span class="n">glVertexAttribPointer</span><span class="p">(</span><span class="n">ATTRIB_COORDS</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GL_FLOAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">textureVertices</span><span class="p">);</span>
</span><span class='line'>        <span class="n">glEnableVertexAttribArray</span><span class="p">(</span><span class="n">ATTRIB_COORDS</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">glDrawArrays</span><span class="p">(</span><span class="n">GL_TRIANGLE_STRIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Simply set the viewport to whole view size and fireup shader that combines both textures into final color.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">mediump</span> <span class="k">vec3</span> <span class="n">yuv</span><span class="p">;</span>
</span><span class='line'><span class="k">mediump</span> <span class="k">vec3</span> <span class="n">rgb</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">yuv</span><span class="p">.</span><span class="n">x</span>  <span class="o">=</span> <span class="n">texture2D</span><span class="p">(</span><span class="n">SamplerY</span><span class="p">,</span> <span class="n">texCoordVarying</span><span class="p">).</span><span class="n">r</span><span class="p">;</span>
</span><span class='line'><span class="n">yuv</span><span class="p">.</span><span class="n">yz</span> <span class="o">=</span> <span class="n">texture2D</span><span class="p">(</span><span class="n">SamplerUV</span><span class="p">,</span> <span class="n">texCoordVarying</span><span class="p">).</span><span class="n">rg</span> <span class="o">-</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">rgb</span> <span class="o">=</span> <span class="k">mat3</span><span class="p">(</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span class='line'>            <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">.18732</span><span class="p">,</span> <span class="mf">1.8556</span><span class="p">,</span>
</span><span class='line'>            <span class="mf">1.57481</span><span class="p">,</span> <span class="o">-</span><span class="mf">.46813</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">yuv</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>One more thing thanks to shaders and realtime computing i was eg able to do relatime saturation filter, filter itself is quiet simple. You just take a output color as vector3 and get as result dot product of the color and some precomuted constant value vector</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">mediump</span> <span class="k">vec3</span> <span class="n">gray</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.2126</span><span class="p">,</span> <span class="mf">0.7152</span><span class="p">,</span> <span class="mf">0.0722</span><span class="p">)));</span>
</span><span class='line'><span class="k">mediump</span> <span class="k">vec3</span> <span class="n">outColor</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">gray</span><span class="p">,</span> <span class="n">saturationFactor</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>See that we use uniform to mix between gray and output color.</p>

<p>And that&rsquo;s all i&#8217;v got for today as always <A HREF="https://github.com/noxytrux/CustomCameraiPhone">full source code</A> available on my github. As you can see now you can apply multiple effects on you camera simply by writing some additional shaders or extending current one, and all works in realtime.</p>

<p>P.S. Remember that you need to run this on physical device to use camera as it is not available on simulator.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-12-20T15:36:32+01:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/camera/'>camera</a>, <a class='category' href='/blog/categories/effects/'>effects</a>, <a class='category' href='/blog/categories/ios/'>ios</a>, <a class='category' href='/blog/categories/iphone/'>iphone</a>


</div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
	
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    Marcin Pędzimąż

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>